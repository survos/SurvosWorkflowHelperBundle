{% extends ['base.html.twig', '@SurvosWorkflow/layout.html.twig'] %}

{% block page_title "%s Workflow"|format(flowCode) %}
{% block page_subtitle "Place count?" %}

{% block javascripts %}
    {{ parent() }}
    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/viz.js@1.8.0/viz.js" type="javascript/worker"></script>
    <script src="https://unpkg.com/d3-graphviz@1.4.0/build/d3-graphviz.min.js"></script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function() {
            let d = document.getElementById('digraph').innerText;
            console.log(d);
                d3.select("#graph").graphviz()
                    .fade(false)
                    .renderDot(d);
            //     // Handler for .ready() called.
            // your code here
        }, false);
        window.onload = ( () => {
        });
        // $(function() {
        //     let d = $('#digraph').text()
        // });


    </script>

{#    <script>#}
{#        $(function() {#}
{#            let d = $('#digraph').text();#}
{#            console.log(d);#}
{#            d3.select("#graph").graphviz()#}
{#                .fade(false)#}
{#                .renderDot(d);#}
{#            // Handler for .ready() called.#}
{#        });#}
{#    </script>#}

{% endblock %}

{% block survos_workflow_body %}

    survos_workflow_body
    {{ block('main') }}

    <div class="container-fluid">
        {{ workflow_diagram(entity, flowCode, 'LR') }}
        <div class="row row-fluid">
            <div class="col-md-6 col-6">
                {{ block('places') }}
            </div>
            <div class="col-md-6">
                {{ block('transitions') }}

            </div>
        </div>
    </div>

    <hr />

    <div class="row row-fluid">
        <div class="col-md-6 col-6">
            <div id="graph" style="text-align: center; width: 100% " ></div>
        </div>

        <div class="col-md-3">
            {{ block('places') }}
        </div>

        <div class="col-md-3">
            {{ block('transitions') }}
        </div>

    </div>

    <div id="digraph" class="digraph" >{{ workflow_digraph(entity, flowCode, 'LR')|raw }}</div>
    <pre style="display: none;">
    </pre>

{% endblock %}

{% block places %}
<h3>{{ flowCode }} States</h3>
<ul class="list list-unstyled">

    {% for place in definition.places|filter( (place) => not (place in definition.initialPlaces) ) %}
        <li><b>{{ place }}</b>:
            <i>
                {{ workflow_metadata(entity, 'description', place, flowCode) ? workflow_metadata(entity, 'description', place, flowCode)|trans : '' }}
            </i>
            <a class="hidden-print" href="{{ path('survos_workflow', {flowCode: flowCode, class: class, states: place|json_encode}) }}">Set</a>
        </li>
    {% endfor %}

</ul>
{% endblock %}

{% block transitions %}
<h3>{{ flowCode }} Transitions</h3>
<ul class="list list-unstyled">
    {% for t in definition.transitions %}
        <li>
            <i>{{ t.name }}</i>
            <span class="pull-right">
                                {{ t.froms|join(',') }}
                                <i class="fa fa-arrow-circle-right"></i> {{ t.tos|join(',') }}
                            </span>
            <br />
            {{ workflow_metadata(entity, 'description', t, flowCode)  }}
        </li>
    {% endfor %}
</ul>
{% endblock %}

{% block body %}

    <pre style="display: none;">
    <div id="digraph" class="digraph" >{{ workflow_digraph(entity, flowCode, 'LR')|raw }}</div>
    </pre>

    {{ 0 and workflow_diagram(entity, flowCode, 'LR') }}
    <div id="graph" style="text-align: center; width: 100% " ></div>

    {% set article = entity %}
    <div class="row row-fluid">
        <div class="col-md-6 col-6">
            #graph
        </div>

        <div class="col-md-3">
            {{ block('places') }}
        </div>

        <div class="col-md-3">
            {{ block('transitions') }}
        </div>

    </div>

    <h1>Article "{{ article }}"</h1>
    <div class="row">
        <div class="col-md-3">
            <h2>Current Marking</h2>
            <p>
                <code>
                    AppBundle\Entity\Article::marking
                </code>
                <br />
                =
                <br />
                <code>{{ article.marking|keys|join('</code>, <code>')|default('[]')|raw }}</code>
            </p>

            <form action="{{ path('survos_workflow', {id: article.id}) }}" method="post" class="form-inline">
                <button type="submit" class="btn btn-danger btn-xs">Reset marking</button>
            </form>
        </div>
        <div class="col-md-3">
            <h2>What can you do?</h2>


            <form xxxaction="{{ path('survos_workflow', {id: article.id}) }}" method="get">
                <div class="btn-group-vertical" role="group">
                    {% for transition in workflow_transitions(article, flowCode) %}
                        <button type="submit" name="transition" value="{{ transition.name }}"
                                {% if workflow_can(article, transition.name, flowCode) -%}
                                    class="btn btn-primary"
                                {%- else -%}
                                    class="btn btn-danger" disabled="disabled"
                                {%- endif -%}
                        >
                            {{ transition.name }}
                        </button>
                    {% endfor %}
                </div>
            </form>
            <br />
            {% if not workflow_transitions(article, flowCode) %}
                <strong>The article can not apply any transition.</strong>
                <br />
                May be you can try with another user ;
                she may have more permissions than you.
            {% endif %}
        </div>
        <div class="col-md-3">
            <h2>Why you can't?</h2>
            <ul class="list-unstyled">
                {% for transition in workflow_transitions(article, flowCode) %}
                    {% if not workflow_can(article, transition.name, flowCode) %}
                        <li>
                            <strong>{{ transition.name }}</strong>:
                            <ul class="list-unstyled">
                                {% for blocker in workflow_transition_blockers(article, transition.name, flowCode) %}
                                    <li>
                                        {{ blocker.message }}
                                        {% if blocker.parameters.expression is defined %}
                                            <code>{{ blocker.parameters.expression }}</code>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        <div class="col-md-3">
            <h2>Metadata</h2>
            <p>

                <strong>Workflow {{ flowCode }}</strong>:<br >
                <code>{{ workflow_metadata(article, 'title', null, flowCode) }}</code>
            </p>
            <p>
                <strong>Current place(s)</strong>
            <ul>
                {% for place in workflow_marked_places(article, true, flowCode) %}
                    <li>
                        {{ place }}:
                        <code>{{ workflow_metadata(article, 'title', place, flowCode) ?: 'n-a'}}</code>
                    </li>
                {% endfor %}
            </ul>
            </p>
            <p>
                <strong>Enabled transition(s)</strong>
            <ul>
                {% for transition in workflow_transitions(article, flowCode) %}
                    <li>
                        {{ transition.name }}:
                        <code>{{ workflow_metadata(article, 'title', transition, flowCode) ?: 'n-a'}}</code>
                    </li>
                {% endfor %}
            </ul>
            </p>
        </div>
    </div>
{% endblock %}
